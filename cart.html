<!DOCTYPE html><html lang="hy"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="assets/style.css"><title>Վճարում</title>
</head><body>
<div class="nav"><div class="container"><div><b>La Tavola</b></div>
<div class="nav-actions"><a href="index.html">Գլխավոր</a><a href="menu.html">Մենյու</a><a href="reserve.html">Ամրագրում</a>
<a href="cart.html">Վճարում</a><a href="auth.html" data-auth="login">Մուտք / Գրանցում</a>
<div class="nav-account" data-auth="account"><a href="account.html" class="nav-account-name">Իմ հաշիվ</a><button type="button" class="btn-link nav-logout">Ելք</button></div></div></div></div>

<div class="page-header">
  <div class="container">
    <h1>Ձեր Պայուսակ</h1>
    <p>Ստուգեք ձեր պատվերը և ավարտեք ցանցը</p>
  </div>
</div>

<div class="container">
  <div class="checkout-wrapper">
    <div class="cart-items">
      <h2>Պատվերի իրեր</h2>
      <div id="bag" class="cart-grid"></div>
      <div class="cart-summary">
        <h3 id="total"></h3>
      </div>
    </div>

    <div class="checkout-form">
      <h2>Վճարման Տեղեկատվություն</h2>
      <form id="checkoutForm">
        <div class="form-group">
          <label for="cid">Հաճախորդի ID</label>
          <input id="cid" class="input" type="text" placeholder="Օր. 1" required>
        </div>

        <div class="form-group">
          <label for="pay">Վճարման եղանակ</label>
          <select id="pay" class="input">
            <option value="">Ընտրել վճարման եղանակ</option>
            <option>Քարտ (թեստ)</option>
            <option>Կանխիկ տեղում</option>
          </select>
        </div>

        <button type="button" class="btn btn-submit" id="btnPay">Հաստատել Պատվերը</button>
        <p id="msg" class="form-message"></p>
      </form>
    </div>
  </div>
</div>

<script src="js/cart.js"></script>
<script src="js/api.js"></script>
<script>
const bagDiv = document.getElementById('bag');
const cidInput = document.getElementById('cid');
const storedCustomer = getCustomer();
if (storedCustomer) {
  cidInput.value = storedCustomer.customer_id;
  cidInput.readOnly = true;
  cidInput.classList.add('input-readonly');
}
function render(){
  bagDiv.innerHTML='';
  const items = getCart();
  let sum=0;
  if (items.length === 0) {
    bagDiv.innerHTML = '<p class="empty-cart">Պայուսակը դատարկ է</p>';
  } else {
    items.forEach(it=>{
      sum += it.price*it.qty;
      const c=document.createElement('div'); c.className='cart-item';
      c.innerHTML = `
        <div class="item-info">
          <h4>${it.name}</h4>
          <p class="item-price">${it.price.toFixed(2)} ֏</p>
        </div>
        <div class="item-controls">
          <button type="button" class="qty-btn" onclick="changeQty(${it.menuitem_id},-1)">−</button>
          <span class="qty-display">${it.qty}</span>
          <button type="button" class="qty-btn" onclick="changeQty(${it.menuitem_id},1)">+</button>
          <span class="item-total">${(it.price*it.qty).toFixed(2)} ֏</span>
        </div>
      `;
      bagDiv.appendChild(c);
    });
  }
  document.getElementById('total').textContent = 'Ընդամենը՝ ' + sum.toFixed(2) + ' ֏';
}
render();

document.getElementById('btnPay').onclick = async () => {
  const msg = document.getElementById('msg');
  const customer = getCustomer();
  if (!customer) {
    msg.textContent = 'Վճարման համար նախ մուտք գործեք ձեր հաշիվ։';
    msg.className = 'form-message error';
    return;
  }
  const fd = new FormData();
  fd.append('customer_id', customer.customer_id);
  fd.append('paymentmethod', document.getElementById('pay').value);
  fd.append('items', JSON.stringify(getCart()));
  const r = await fetch('php/order_create.php', {method:'POST', body:fd});
  const j = await r.json().catch(()=>({ok:false,msg:'Սերվերի սխալ'}));
  msg.textContent = j.ok ? ('Պատվեր #' + j.order_id + ' — հաջողվեց') : (j.msg||'Սխալ');
  msg.className = 'form-message ' + (j.ok ? 'success' : 'error');
  if (j.ok) { clearCart(); render(); }
};
</script>
</body></html>
